# 通知诊断功能说明

## 问题分析

您报告的问题：设置定时通知后，到了时间没有通知发出，也没有日志记录。

经过代码分析，我发现了关键信息：

### 通知触发时没有日志是正常的

这不是 bug，而是 Android/iOS 操作系统的设计限制：

- **调度通知时**：Dart 代码运行，可以记录日志 ✅
- **通知触发时**：由操作系统直接显示，Dart 代码不运行，无法记录日志 ❌
- **点击通知时**：Dart 代码运行，可以记录日志 ✅

**原因**：Android 的 `AlarmManager` API 不提供回调来通知应用"通知已触发"。为了省电和性能，通知直接由系统显示，不启动应用。

详细技术说明请查看：`NOTIFICATION_BEHAVIOR_EXPLAINED.md`

---

## 本次改进内容

为了帮助您诊断通知问题，我添加了以下功能：

### 1. 测试通知日志 ✨

**改进前**：
```
✓ 测试通知已发送 (ID: 2000123456)
(但调试控制台中看不到)
```

**改进后**：
```
✓ 测试通知已发送 (ID: 2000123456)
[14:30:15] [INFO] [Notification] Test notification sent: 测试事件 (ID: 2000123456)
(会显示在调试控制台中)
```

**用途**：验证日志系统本身是否正常工作。

---

### 2. 通知队列自动验证 ✨ **最重要**

**改进内容**：每次设置通知后，自动检查通知是否成功添加到 Android 系统队列。

**成功情况** (通知已正确调度):
```
[14:23:08] [INFO] [Notification] Scheduled 1 reminders for event: qwq
[14:23:08] [INFO] [Notification] Notification queue verified: 1 notifications in system queue
```

**失败情况** (通知未能添加到系统):
```
[14:23:08] [INFO] [Notification] Scheduled 1 reminders for event: qwq
[14:23:08] [WARN] [Notification] Notification queue verification failed: expected 1, found 0
```

**如何使用**：
1. 设置一个定时通知
2. 立即查看调试控制台
3. 寻找 "Notification queue verified" 日志

**诊断结果**：
- ✅ 看到 "Notification queue verified: 1 notifications in system queue"
  - 说明通知**已成功**添加到系统队列
  - 到时间系统会触发通知
  - 如果到时间还是没有通知，问题在于**系统省电策略**或**权限**

- ❌ 看到 "Notification queue verification failed"
  - 说明通知**未能**添加到系统队列
  - 问题可能是：
    - 权限未授予
    - 通知时间已过期
    - 系统不支持精确定时
    - 代码错误

---

## 如何诊断您的问题

### 步骤 1: 设置测试通知

1. 创建一个测试事件，目标日期设为明天
2. 点击 "发送测试通知"
3. 检查：
   - ✅ 是否收到通知？
   - ✅ 调试控制台是否显示 `[INFO] [Notification] Test notification sent`？

**如果测试通知能收到且有日志**：
- 说明通知功能和日志系统都正常
- 问题出在定时通知上，继续步骤 2

**如果测试通知收不到**：
- 检查通知权限
- 检查系统设置中的通知开关
- 检查勿扰模式

---

### 步骤 2: 设置短时间定时通知

1. 编辑同一个事件
2. 添加提醒：
   - 提前天数：0 天
   - 提醒时间：**当前时间 + 2 分钟** (比如现在是 14:30，就设置 14:32)
3. 保存
4. **立即**查看调试控制台，寻找这两条日志：
   ```
   [INFO] [Notification] Scheduled 1 reminders for event: xxx
   [INFO] [Notification] Notification queue verified: 1 notifications in system queue
   ```

---

### 步骤 3: 根据日志诊断

#### 情况 A: 看到 "Notification queue verified: 1 notifications in system queue"

✅ **好消息**：通知已成功添加到系统队列！

现在等待 2 分钟：

- **如果收到通知** ✅
  - 说明一切正常！
  - 之前的问题可能是时间设置错误，或者等待时间太长忘记了

- **如果没收到通知** ❌
  - 问题在于**系统杀掉了通知**
  - 可能原因：
    1. **省电模式** (最常见)
    2. **后台限制**
    3. **应用被系统杀掉**

  **解决方法**：
  - 进入系统设置 → 应用 → 萤 (Ying)
  - 关闭 "省电优化" 或 "电池优化"
  - 允许 "后台运行" 和 "自启动"
  - 在多任务界面锁定应用（下拉/长按应用卡片）

---

#### 情况 B: 看到 "Notification queue verification failed: expected 1, found 0"

❌ **问题**：通知未能添加到系统队列

**诊断步骤**：

1. 检查权限日志（在同一调试控制台中向上翻）：
   ```
   [INFO] [Notification] 通知服务初始化成功
   [INFO] [Notification] Notification permission granted: true
   [INFO] [Notification] Exact alarm permission granted: true
   ```

   - 如果 `Notification permission granted: false`
     - 进入系统设置 → 应用 → 萤 → 权限 → 通知，打开

   - 如果 `Exact alarm permission granted: false` (Android 12+)
     - 进入系统设置 → 应用 → 萤 → 特殊访问权限 → 闹钟和提醒，打开

2. 检查是否有调度失败日志：
   ```
   [ERROR] [Notification] Failed to schedule reminder: ...
   ```
   - 如果有，将错误信息反馈给开发者

3. 检查通知时间是否正确：
   ```
   ✓ 已调度提醒: 事件名称 - 2026-02-15T14:32:00.000+08:00
   ```
   - 确认时间是否是未来时间
   - 确认时区是否正确 (UTC+8 是中国标准时间)

---

#### 情况 C: 没有看到任何 "Scheduled" 日志

**原因**：通知根本没有被调度

**检查**：
1. 事件是否启用了通知？（编辑事件，检查 "启用通知" 开关）
2. 是否添加了提醒？（至少要有一条提醒规则）
3. 提醒时间是否已过期？
   - 如果看到 `⏭ 提醒时间已过，跳过`，说明设置的时间在过去

---

## 额外诊断工具

### 查看当前所有待处理通知

在调试控制台中：
1. 点击 "系统" 标签页
2. 查看 "待处理通知" 部分
3. 应该能看到所有已调度的通知

---

## 常见问题 FAQ

### Q1: 为什么测试通知有日志，但也没有"已显示"的日志？

A: 因为 Android 的 `.show()` 方法是同步的，调用后立即返回，系统会异步显示通知。我们只能记录"已请求显示"，无法记录"已显示"（因为没有回调）。

但这不影响诊断，因为测试通知会立即显示，你能直接看到结果。

---

### Q2: 队列验证成功，但到时间没通知，怎么办？

A: 这说明问题在于**系统杀掉了定时任务**，不是代码问题。

**重点检查**：
1. 省电模式/电池优化（针对本应用）
2. 后台运行权限
3. 自启动权限
4. 手机厂商的省电策略（小米、华为、OPPO、vivo 特别严格）

**验证方法**：
- 设置短时间通知（2分钟后）
- 在这 2 分钟内**保持应用在前台**
- 如果这样能收到通知，说明就是后台被杀掉的问题

---

### Q3: 我的手机是小米/华为/OPPO，怎么设置？

A: 这些厂商的省电策略很严格，需要特殊设置：

**小米 (MIUI)**：
1. 设置 → 应用设置 → 应用管理 → 萤
2. 省电策略 → 无限制
3. 后台弹出界面 → 允许
4. 开机自启动 → 允许

**华为 (EMUI/HarmonyOS)**：
1. 设置 → 应用 → 应用启动管理 → 萤
2. 改为手动管理
3. 三个开关全部打开（允许自启动、后台活动、关联启动）

**OPPO (ColorOS)**：
1. 设置 → 电池 → 应用耗电管理 → 萤
2. 允许后台运行
3. 设置 → 应用管理 → 萤 → 权限 → 自启动 → 允许

**vivo (OriginOS/FuntouchOS)**：
1. i 管家 → 应用管理 → 自启动 → 萤 → 允许
2. 设置 → 电池 → 高耗电 → 萤 → 允许后台高耗电

---

## 总结

**关键理解**：
1. ✅ 通知触发时没有日志是**正常的**，不是 bug
2. ✅ 通过**队列验证日志**可以判断通知是否成功调度
3. ✅ 如果队列验证成功但没通知，问题在**系统省电策略**
4. ✅ 测试通知能帮助快速验证权限和系统配置

**诊断流程**：
```
测试通知 → 短时间定时通知 → 查看队列验证日志 →
  成功: 检查省电设置
  失败: 检查权限和错误日志
```

---

**需要帮助？**

如果按照以上步骤仍无法解决，请提供以下信息：

1. 手机品牌和型号
2. Android 版本
3. 完整的调试控制台日志（从应用启动到设置通知）
4. 权限设置截图
5. 省电设置截图

我会进一步协助诊断！

---

**相关文档**：
- `NOTIFICATION_BEHAVIOR_EXPLAINED.md` - 详细技术说明
- `NOTIFICATION_TESTING.md` - 测试指南

**更新日期**：2026-02-15
