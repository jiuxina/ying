# 调试功能实现总结

## 问题陈述
在app的设置界面中增加一个调试功能，打开后会请求悬浮窗权限然后出现悬浮窗，可以查看app的所有行为和进程以及各自细节等等。

## 实现方案

### 1. 核心架构

#### DebugService (lib/services/debug_service.dart)
- **设计模式**: 单例模式
- **功能**:
  - 日志收集（最多500条）
  - 路由导航追踪（最多50条）
  - 系统信息收集
  - 应用生命周期状态监控
  - 观察者模式支持实时更新

#### DebugOverlayWidget (lib/widgets/debug/debug_overlay_widget.dart)
- **UI组件**: 三标签页布局
  - 日志标签页：显示所有级别的日志
  - 路由标签页：显示导航历史
  - 系统标签页：显示系统信息和应用状态
- **交互功能**:
  - 清空日志/路由历史
  - 刷新系统信息
  - 实时数据更新（每秒）

#### DebugSettingsScreen (lib/screens/settings/debug_settings_screen.dart)
- **权限管理**: 请求和检查悬浮窗权限
- **悬浮窗控制**: 打开/关闭悬浮窗
- **状态显示**: 实时显示调试统计信息

### 2. 集成点

#### 主应用 (lib/main.dart)
- 添加悬浮窗入口点 `overlayMain()`
- 集成应用生命周期监听
- 初始化 DebugService

#### 路由观察器 (lib/utils/route_observer.dart)
- 集成 DebugService 路由追踪
- 记录所有导航操作（push, pop, replace）

#### 设置提供者 (lib/providers/settings_provider.dart)
- 添加 `debugModeEnabled` 状态
- 持久化调试模式设置

#### 设置界面 (lib/screens/settings_screen.dart)
- 添加调试功能入口

### 3. 依赖和权限

#### 新增依赖
```yaml
flutter_overlay_window: ^0.5.2
```

#### Android 权限
```xml
<uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>
```

### 4. 测试覆盖

#### 单元测试 (test/services/debug_service_test.dart)
- 11个测试用例
- 覆盖场景:
  - 单例模式验证
  - 日志级别和消息
  - 最大日志限制
  - 路由历史记录
  - 状态更新
  - 系统信息收集
  - 监听器通知
  - 时间格式化

### 5. 文件结构

```
lib/
├── services/
│   └── debug_service.dart          # 调试服务核心
├── widgets/
│   └── debug/
│       └── debug_overlay_widget.dart  # 悬浮窗UI
├── screens/
│   └── settings/
│       └── debug_settings_screen.dart # 调试设置页面
└── ...

test/
└── services/
    └── debug_service_test.dart     # 单元测试

DEBUG_FEATURE_GUIDE.md              # 用户指南
```

### 6. 关键特性

✅ **安全性**
- 仅在调试模式启用时收集数据
- 无安全漏洞（已通过依赖检查）
- 日志和历史有最大限制，防止内存溢出

✅ **性能**
- 循环缓冲区设计，自动清理旧数据
- 仅在需要时更新UI
- 轻量级的监听器模式

✅ **用户体验**
- 清晰的UI布局
- 实时数据更新
- 可拖动的悬浮窗
- 简单的开关控制

✅ **开发体验**
- 完整的单元测试
- 清晰的代码结构
- 详细的用户文档
- 符合项目编码规范

## 使用流程

1. 用户打开设置 → 其他 → 调试功能
2. 开启"启用调试模式"开关
3. 点击"打开悬浮窗"
4. 首次使用时授予悬浮窗权限
5. 悬浮窗显示，可查看实时调试信息
6. 使用完毕后关闭悬浮窗

## 技术亮点

1. **单例模式**: DebugService 确保全局唯一实例
2. **观察者模式**: 支持UI实时响应数据变化
3. **循环缓冲**: 自动管理日志和历史记录数量
4. **生命周期集成**: 自动追踪应用状态变化
5. **路由追踪**: 自动记录所有导航操作

## 后续优化建议

1. 添加日志导出功能
2. 支持自定义悬浮窗大小
3. 添加日志过滤和搜索功能
4. 支持性能指标监控（CPU、内存使用）
5. 添加网络请求监控

---

实现完成日期: 2026-02-14

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          萤 App 主界面                           │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    设置 (Settings)                         │  │
│  │                                                            │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │                  其他 (Other)                         │ │  │
│  │  │                                                       │ │  │
│  │  │  ┌─────────────────────────────────────────────────┐ │ │  │
│  │  │  │  🐛 调试功能 (Debug Feature)                    │ │ │  │
│  │  │  │                                                  │ │ │  │
│  │  │  │  DebugSettingsScreen                            │ │ │  │
│  │  │  │  ├─ 启用调试模式 (Toggle)                        │ │ │  │
│  │  │  │  ├─ 悬浮窗状态 (Status)                          │ │ │  │
│  │  │  │  ├─ 打开/关闭悬浮窗 (Open/Close)                │ │ │  │
│  │  │  │  ├─ 调试统计 (Stats)                            │ │ │  │
│  │  │  │  └─ 调试操作 (Actions)                          │ │ │  │
│  │  │  └─────────────────────────────────────────────────┘ │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 启用调试模式
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DebugService (Singleton)                     │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────────┐  │
│  │  日志收集     │  │  路由追踪     │  │   系统信息收集       │  │
│  │              │  │              │  │                      │  │
│  │ • Info       │  │ • Push       │  │ • Platform          │  │
│  │ • Warning    │  │ • Pop        │  │ • OS Version        │  │
│  │ • Error      │  │ • Replace    │  │ • Processors        │  │
│  │ • Debug      │  │              │  │ • Dart Version      │  │
│  │              │  │ Max: 50      │  │                      │  │
│  │ Max: 500     │  │              │  │                      │  │
│  └──────────────┘  └──────────────┘  └─────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              应用生命周期监控                              │  │
│  │  Resumed | Inactive | Paused | Detached | Hidden         │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 数据流
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   悬浮窗 (Overlay Window)                        │
│                   DebugOverlayWidget                            │
│                                                                 │
│  ┌─────────────┬─────────────┬─────────────────────────────┐  │
│  │  📝 日志     │  🧭 路由     │  💻 系统                      │  │
│  │             │             │                              │  │
│  │ [清空]      │ [清空]      │ [刷新]                        │  │
│  │             │             │                              │  │
│  │ ┌─────────┐ │ ┌─────────┐ │ ┌──────────────────────────┐ │  │
│  │ │ [Info]  │ │ │14:30:25 │ │ │ 应用状态: Resumed         │ │  │
│  │ │Message1 │ │ │-> /home │ │ │                          │ │  │
│  │ └─────────┘ │ └─────────┘ │ │ 系统信息:                 │ │  │
│  │ ┌─────────┐ │ ┌─────────┐ │ │ • Platform: android       │ │  │
│  │ │ [Error] │ │ │14:30:30 │ │ │ • Processors: 8          │ │  │
│  │ │Message2 │ │ │->/debug │ │ │ • Dart: 3.9.2            │ │  │
│  │ └─────────┘ │ └─────────┘ │ └──────────────────────────┘ │  │
│  │             │             │                              │  │
│  │ 共 X 条日志  │ 共 X 条记录  │                              │  │
│  └─────────────┴─────────────┴─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

数据采集点:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. GlobalRouteObserver ───► 路由导航事件 ───► DebugService
2. YingApp (WidgetsBindingObserver) ───► 生命周期事件 ───► DebugService
3. 各服务/组件 ───► debugPrint() ───► DebugService.log()
4. Platform APIs ───► 系统信息 ───► DebugService
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 数据流图

```
用户操作                      应用响应
   │                           │
   ▼                           ▼
开启调试模式 ────────► DebugService.initialize()
   │                           │
   │                           ├─► 收集系统信息
   │                           ├─► 初始化日志存储
   │                           └─► 记录初始化日志
   │
   ▼
点击打开悬浮窗 ──────► 检查权限
   │                    │
   │                    ├─► 无权限 ──► 请求 SYSTEM_ALERT_WINDOW 权限
   │                    │                      │
   │                    │                      ├─► 授予 ──► 显示悬浮窗
   │                    │                      └─► 拒绝 ──► 显示错误提示
   │                    │
   │                    └─► 有权限 ──► FlutterOverlayWindow.showOverlay()
   │                                              │
   │                                              ▼
   │                                   创建 DebugOverlayWidget 实例
   │                                              │
   │                                              ├─► 订阅 DebugService 更新
   │                                              ├─► 启动定时器（每秒刷新）
   │                                              └─► 显示三个标签页
   │
应用运行时
   │
   ├─► 路由导航 ────────────────► GlobalRouteObserver
   │                                    ▼
   │                           debugService.recordRoute()
   │                                    ▼
   │                           通知所有监听器（包括悬浮窗）
   │
   ├─► 生命周期变化 ────────────► YingApp.didChangeAppLifecycleState()
   │                                    ▼
   │                           debugService.updateAppState()
   │                                    ▼
   │                           通知所有监听器
   │
   └─► 应用日志 ─────────────────► debugService.log/info/warning/error()
                                        ▼
                              添加到日志队列（最多500条）
                                        ▼
                              通知所有监听器
                                        ▼
                              悬浮窗实时更新显示
```
