# 调试悬浮窗功能说明

## 概述

调试悬浮窗是一个强大的开发和调试工具，用于实时监控和诊断应用的通知系统和其他关键功能。此功能仅在调试模式（`kDebugMode`）下可用，不会影响正式发布的应用。

## 功能特性

### 1. 实时日志监控
- **自动记录**：自动捕获所有关键操作和事件
- **分类管理**：支持多种日志类型（信息、成功、警告、错误、通知、权限、时区、事件）
- **时间戳**：精确到百分之一秒的时间记录
- **搜索筛选**：支持按关键词搜索和按类型筛选
- **日志复制**：长按日志条目可复制到剪贴板

### 2. 通知队列监控
- **队列统计**：显示当前待处理的通知数量
- **详细信息**：展示每个通知的 ID、标题、内容
- **实时刷新**：支持下拉刷新最新数据
- **信息导出**：可复制单个通知的详细信息

### 3. 权限状态检查
- **通知权限**：实时显示通知权限授予状态
- **精确闹钟权限**：显示精确闹钟权限状态
- **警告提示**：自动检测并提示权限相关问题
- **优化建议**：提供详细的系统设置指导

### 4. 交互设计
- **可拖动**：悬浮窗可在屏幕上自由拖动
- **最小化**：支持最小化以避免遮挡主界面
- **标签切换**：三个标签页（日志、通知、权限）快速切换
- **半透明背景**：点击背景可关闭悬浮窗

## 使用方式

### 开启调试窗口

1. **在调试模式下运行应用**
   ```bash
   flutter run --debug
   ```

2. **打开悬浮窗**
   - 进入应用首页
   - 点击右下角的悬浮操作按钮（FAB）
   - 在展开的菜单中，点击紫色的"调试"按钮（🐛图标）

### 使用调试窗口

#### 日志标签页
1. **查看日志**：最新的日志显示在顶部
2. **搜索日志**：在搜索框中输入关键词
3. **筛选类型**：点击类型芯片筛选特定类型的日志
4. **清空日志**：点击删除图标清空所有日志
5. **复制日志**：长按任意日志条目复制到剪贴板

#### 通知标签页
1. **查看队列**：显示所有待处理的通知
2. **刷新数据**：下拉刷新最新的通知队列
3. **复制信息**：点击复制图标复制通知详情

#### 权限标签页
1. **检查权限**：查看各项权限的授予状态
2. **查看警告**：橙色卡片显示需要注意的问题
3. **查看建议**：蓝色卡片提供优化建议
4. **刷新状态**：下拉刷新最新的权限状态

### 窗口操作

- **拖动窗口**：按住标题栏拖动窗口到任意位置
- **最小化**：点击标题栏的最小化按钮
- **展开**：点击最小化后的窗口可重新展开
- **刷新数据**：点击刷新按钮更新通知和权限数据
- **关闭窗口**：点击关闭按钮或点击背景区域

## 技术实现

### 核心组件

#### DebugLogger 服务
- **单例模式**：全局唯一实例，确保日志一致性
- **自动启用控制**：仅在 `kDebugMode` 为 true 时启用
- **内存管理**：自动限制日志条目数量（最多 500 条）
- **监听机制**：支持实时监听日志变化

#### DebugFloatingWindow 组件
- **悬浮对话框**：使用 `showDialog` 实现悬浮效果
- **拖动支持**：通过 `GestureDetector` 实现拖动
- **标签切换**：使用 `TabController` 管理三个标签页
- **实时更新**：监听 DebugLogger 的变化自动刷新 UI

### 集成点

在 `NotificationService` 中的关键集成点：

1. **初始化**：记录时区设置、初始化成功/失败
2. **权限请求**：记录权限授予/拒绝状态
3. **通知调度**：记录每次通知调度的详细信息
4. **错误处理**：记录所有异常和错误

## 日志类型说明

| 类型 | 图标 | 用途 | 示例 |
|------|------|------|------|
| info | ℹ️ | 一般信息 | "开始初始化通知服务..." |
| success | ✅ | 成功操作 | "通知服务初始化成功" |
| warning | ⚠️ | 警告信息 | "精确闹钟权限未授予，通知可能不准时" |
| error | ❌ | 错误信息 | "通知服务初始化失败" |
| notification | 🔔 | 通知相关 | "调度通知: 生日提醒" |
| permission | 🔐 | 权限相关 | "通知权限已授予" |
| timezone | 🌏 | 时区配置 | "时区设置成功: Asia/Shanghai (UTC+8)" |
| event | 📅 | 事件操作 | "创建新事件: 纪念日" |

## 调试最佳实践

### 1. 排查通知不触发问题

**步骤：**
1. 打开调试窗口，切换到"权限"标签
2. 检查"通知权限"和"精确闹钟权限"是否都显示为绿色✅
3. 如果有警告，按照建议进行设置
4. 切换到"通知"标签，确认事件的通知已在队列中
5. 查看"日志"标签，搜索事件名称，检查是否有调度成功的日志
6. 如果显示"提醒时间已过，跳过"，说明通知时间设置有问题

### 2. 检查通知调度流程

**步骤：**
1. 创建或编辑一个事件并设置提醒
2. 打开调试窗口，切换到"日志"标签
3. 筛选"通知 🔔"类型的日志
4. 查找以下关键日志：
   - "开始调度事件通知"
   - "调度通知: [事件名称]"
   - "通知已调度: [事件名称]"
5. 检查是否有"调度提醒失败"的错误日志

### 3. 监控应用启动流程

**步骤：**
1. 重启应用
2. 立即打开调试窗口
3. 查看日志，按时间顺序检查：
   - 时区设置
   - 通知服务初始化
   - 权限请求
   - 通知重新调度
4. 确认所有步骤都成功完成

### 4. 诊断权限问题

**步骤：**
1. 打开调试窗口，切换到"权限"标签
2. 下拉刷新，确保获取最新状态
3. 检查"警告"部分是否有提示
4. 根据"建议"部分的指引进行设置
5. 设置完成后，再次刷新验证

## 常见问题

### Q: 为什么我看不到"调试"按钮？
**A**: 调试功能仅在调试模式下可用。请确保：
1. 使用 `flutter run --debug` 命令运行应用
2. 应用是以 Debug 配置编译的
3. `kDebugMode` 为 true

### Q: 日志太多了，如何查找特定信息？
**A**: 有以下几种方式：
1. 使用搜索框输入关键词
2. 使用类型筛选芯片选择特定类型
3. 结合搜索和筛选缩小范围
4. 清空旧日志，重新触发操作

### Q: 悬浮窗遮挡了主界面怎么办？
**A**: 可以：
1. 拖动窗口到屏幕边缘
2. 点击最小化按钮缩小窗口
3. 点击背景或关闭按钮暂时关闭

### Q: 如何在生产环境禁用调试功能？
**A**: 调试功能已自动处理：
- `DebugLogger.isEnabled` 会检查 `kDebugMode`
- 发布版本（Release）会自动禁用所有调试日志
- FAB 中的调试按钮在 Release 模式下不会显示

### Q: 日志会影响应用性能吗？
**A**: 影响极小：
1. 调试模式专用，不影响正式版本
2. 自动限制日志数量（最多 500 条）
3. 异步记录，不阻塞主线程
4. Release 模式下完全禁用

## 开发者注意事项

### 添加新的日志记录点

```dart
final DebugLogger _logger = DebugLogger();

// 记录信息
_logger.info('操作描述');

// 记录成功
_logger.success('操作成功');

// 记录警告
_logger.warning('警告信息', data: {'detail': '详细数据'});

// 记录错误
_logger.error('错误信息', data: {'error': e.toString()});

// 记录特定类型
_logger.notification('通知事件');
_logger.permission('权限事件');
_logger.timezone('时区事件');
_logger.event('事件操作');
```

### 扩展日志类型

如需添加新的日志类型，需要修改：
1. `lib/services/debug_logger.dart` 中的 `DebugLogType` 枚举
2. `DebugLogEntry` 的 `typeIcon` getter
3. `DebugFloatingWindow` 的筛选芯片列表

### 自定义 UI

`DebugFloatingWindow` 的 UI 可以自定义：
- 窗口尺寸：修改 `width` 和 `height` 常量
- 颜色主题：修改各种颜色常量
- 标签页：添加或删除 `TabController` 的 tab
- 布局：修改各个 builder 方法

## 版本历史

### v1.0.0（当前版本）
- ✅ 实时日志监控
- ✅ 通知队列显示
- ✅ 权限状态检查
- ✅ 可拖动悬浮窗
- ✅ 日志搜索和筛选
- ✅ 日志复制功能
- ✅ 调试模式自动启用/禁用

## 未来计划

- [ ] 支持日志导出到文件
- [ ] 添加性能监控（内存、CPU）
- [ ] 支持网络请求监控
- [ ] 添加事件时间线视图
- [ ] 支持远程日志查看（开发环境）
- [ ] 添加截图和录屏功能
- [ ] 支持自定义日志过滤规则

## 相关文件

- `lib/services/debug_logger.dart` - 日志服务实现
- `lib/widgets/debug/debug_floating_window.dart` - 悬浮窗 UI
- `lib/services/notification_service.dart` - 通知服务（集成日志）
- `lib/screens/home_screen.dart` - 首页（调试按钮入口）

## 技术支持

如有问题或建议，请：
1. 查看本文档的"常见问题"部分
2. 检查日志中的错误信息
3. 提交 Issue 到项目仓库
4. 联系开发团队

---

**注意**：此功能仅供开发和调试使用，不会出现在正式发布的应用中。
