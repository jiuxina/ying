# 通知功能测试指南 (Notification Testing Guide)

## 概述
本文档描述如何测试重构后的通知提醒功能。

## 重构内容摘要

### 1. 时区处理优化
- 使用 `Asia/Shanghai` 作为主要时区（中国用户）
- 备选方案：`Asia/Chongqing` -> `UTC`
- 确保通知在正确的时间触发

### 2. 夏令时(DST)处理
- 分两步创建通知时间：
  1. 计算提醒日期（目标日期 - daysBefore）
  2. 设置具体时间（hour:minute）
- 避免跨DST边界的时间计算错误

### 3. Android通知渠道配置
- 振动模式：[0, 500, 200, 500] 毫秒
- LED灯：蓝色 (#2196F3)，亮1秒灭0.5秒
- 高优先级和重要性
- 支持长文本展示

### 4. 权限处理改进
- 应用启动时主动请求权限
- 详细的权限状态日志
- 精确闹钟权限检查和请求

### 5. 并发保护
- 防止多次初始化冲突
- 30秒超时保护
- 线程安全的初始化流程

## 测试步骤

### 前置条件
1. 确保已安装 Flutter SDK 3.9.2+
2. 确保设备/模拟器运行 Android 12+ 或 iOS 14+

### 测试用例

#### 测试1: 基础通知功能
1. 启动应用
2. 检查控制台日志，确认以下信息：
   - `✓ 通知服务使用时区: Asia/Shanghai (UTC+8)`
   - `✓ 通知服务初始化成功`
   - `✓ 通知权限已授予` 或 `⚠️ 通知权限未授予`
   - `✓ 精确闹钟权限已授予` 或相关警告

#### 测试2: 创建带提醒的事件
1. 创建新事件
2. 设置目标日期为未来某天（如明天）
3. 启用通知
4. 添加提醒：
   - 提前0天，时间设为当前时间+2分钟
5. 保存事件
6. 检查日志：`✓ 成功调度 1 个提醒通知`
7. 等待2分钟，验证通知是否显示
8. 点击通知，验证是否跳转到事件详情页

#### 测试3: 多个提醒
1. 编辑事件
2. 添加多个提醒：
   - 提前1天，9:00
   - 提前0天，9:00
   - 提前0天，18:00
3. 保存
4. 检查日志确认所有提醒已调度
5. 使用 "发送测试通知" 功能验证通知样式

#### 测试4: 过期时间处理
1. 创建事件，目标日期为昨天
2. 添加提醒
3. 保存
4. 检查日志：应显示 `⏭ 提醒时间已过，跳过`

#### 测试5: 权限被拒绝
1. 在系统设置中拒绝通知权限
2. 重启应用
3. 检查日志：`⚠️ 通知权限未授予`
4. 创建带提醒的事件
5. 验证应用不会崩溃

#### 测试6: Android 精确闹钟权限
仅限 Android 12+ 设备
1. 设置 -> 应用 -> 萤 -> 特殊访问权限 -> 闹钟和提醒
2. 关闭权限
3. 重启应用
4. 检查日志：应显示详细的权限提示
5. 打开权限
6. 创建提醒验证功能

#### 测试7: 时区一致性
1. 创建事件，提前1天 14:30提醒
2. 检查通知调度日志中的时间
3. 确认时间为本地时间（中国标准时间 UTC+8）
4. 可选：修改系统时区后验证

#### 测试8: DST边界（如适用）
如果测试设备支持夏令时：
1. 创建跨越DST边界的事件
2. 验证提醒时间计算正确

#### 测试9: 通知外观和行为
Android 设备：
1. 触发通知
2. 验证以下特性：
   - 振动模式：短振-停-短振
   - LED灯闪烁（如设备支持）
   - 通知图标显示
   - 长文本可展开
   - 声音播放

iOS 设备：
1. 触发通知
2. 验证：
   - 横幅显示
   - 声音播放
   - 应用图标徽章

#### 测试10: 并发初始化
1. 快速多次打开关闭应用
2. 验证不会出现重复初始化
3. 检查日志无异常

## 预期结果

### 成功标准
- ✅ 所有通知在正确的时间触发
- ✅ 通知样式符合配置（振动、声音、LED）
- ✅ 权限请求流程友好
- ✅ 无崩溃或异常
- ✅ 日志信息清晰有用
- ✅ 时区处理正确（中国用户UTC+8）

### 已知限制
- Android 低于13的版本不需要运行时通知权限
- iOS 测试需要真机（模拟器通知行为可能不同）
- 某些制造商（小米、华为等）可能有额外的省电限制

## 调试技巧

### 查看待处理通知
在应用中添加调试按钮，调用：
```dart
final pending = await NotificationService().getPendingNotifications();
for (var n in pending) {
  print('通知ID: ${n.id}, 标题: ${n.title}, Payload: ${n.payload}');
}
```

### 清除所有通知
```dart
await NotificationService().cancelAllNotifications();
```

### 检查事件的通知数量
```dart
final count = await NotificationService().getEventNotificationCount(eventId);
print('事件 $eventId 有 $count 个待处理通知');
```

## 回归测试
每次修改通知相关代码后，至少执行测试2、3、9。

## 报告问题
如发现问题，请记录：
1. 设备型号和系统版本
2. 完整的控制台日志
3. 重现步骤
4. 预期行为 vs 实际行为
