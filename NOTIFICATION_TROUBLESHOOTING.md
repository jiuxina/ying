# 通知问题排查指南

## 问题：设置了定时通知，但到了时间却没有收到通知

### 症状描述
- 在设置提醒时，日志显示"Scheduled X reminders for event XXX"
- 到了预定时间，没有收到通知
- 调试控制台没有显示通知发送的日志
- 测试通知功能正常（能立即收到通知）

### 根本原因

**重要说明：** 这不是应用的 bug，而是 Android 系统的限制。

`flutter_local_notifications` 插件使用 Android 的 AlarmManager API 来调度通知。但是某些情况下，Android 系统会阻止这些通知触发：

1. **OEM 厂商的电池优化** - 小米、华为、OPPO、vivo 等品牌的手机有激进的后台限制
2. **Android Doze 模式** - 系统为节省电量而限制后台任务
3. **应用被杀死** - 系统或用户清理后台时杀死了应用
4. **通知权限问题** - 缺少必要的权限或权限被撤销

### 诊断步骤

#### 1. 检查通知是否真的被调度了

在应用启动时或设置提醒后，检查"调试控制台"中的日志：

```
Scheduled reminder: [事件名称] at [时间] (ID: [通知ID])
Verified: [数量] notifications confirmed in system queue
```

如果看到 "Verified" 消息，说明通知已成功调度到系统队列。

#### 2. 检查权限状态

打开应用，导航到"设置" -> "调试" -> "通知诊断"，检查：

- ✓ 通知服务初始化: true
- ✓ 通知权限: true  
- ✓ 精确闹钟权限: true
- 📋 待处理通知数量: > 0

如果任何一项为 false 或待处理通知数量为 0，需要进一步排查。

#### 3. 检查系统设置

##### Android 13+ (必需)
1. **通知权限**
   - 设置 → 应用 → 萤 → 通知 → 允许通知

2. **精确闹钟权限** (Android 12+)
   - 设置 → 应用 → 特殊访问权限 → 闹钟和提醒 → 萤 → 允许

##### 电池优化设置 (强烈建议)
不同品牌手机的设置路径不同：

**小米 (MIUI)**
1. 设置 → 应用设置 → 应用管理 → 萤
2. 省电策略 → 无限制
3. 自启动 → 允许
4. 后台弹出界面 → 允许

**华为 (EMUI/HarmonyOS)**
1. 设置 → 应用和服务 → 应用管理 → 萤
2. 电池 → 应用启动管理 → 手动管理
   - 允许自启动
   - 允许关联启动  
   - 允许后台活动

**OPPO (ColorOS)**
1. 设置 → 应用管理 → 萤
2. 应用权限 → 自启动 → 允许
3. 电池 → 不限制

**vivo (OriginOS/Funtouch OS)**
1. 设置 → 应用与权限 → 应用管理 → 萤
2. 电池 → 后台高耗电 → 允许
3. 自启动 → 允许

**原生 Android/三星**
1. 设置 → 应用 → 萤 → 电池
2. 电池优化 → 不限制 (或"不优化")

#### 4. 测试方法

1. **设置一个 2-3 分钟后的提醒**
   - 不要锁屏
   - 保持应用在后台运行
   - 观察是否收到通知

2. **如果收到了**
   - 说明通知功能正常
   - 问题在于手机的省电策略
   - 按照上面的步骤调整设置

3. **如果仍然没收到**
   - 检查调试控制台的日志
   - 查看是否有错误信息
   - 检查待处理通知数量是否为 0

### 技术限制

#### 为什么没有"通知已发送"的日志？

`flutter_local_notifications` 插件使用 Android 的原生通知系统。当通知被调度后：

1. **应用侧**：调用 `zonedSchedule()` 后，通知被交给 Android 系统
2. **系统侧**：Android AlarmManager 在指定时间触发通知
3. **重要**：系统触发通知时，**不会回调 Dart 代码**

这意味着：
- ✓ 可以记录"通知已调度"的日志
- ✓ 可以记录"用户点击通知"的日志  
- ✗ **无法记录"通知已显示"的日志** (系统不提供此回调)

这是 Android 原生通知 API 的限制，不是插件或应用的问题。

#### 为什么测试通知有日志但定时通知没有？

- **测试通知**：使用 `show()` 方法，立即显示，可以在调用后记录日志
- **定时通知**：使用 `zonedSchedule()` 方法，由系统在未来触发，无回调

### 解决方案总结

1. **确保权限已授予**
   - 通知权限 (Android 13+)
   - 精确闹钟权限 (Android 12+)

2. **关闭电池优化**
   - 根据手机品牌按照上面的步骤操作
   - 访问 https://dontkillmyapp.com 查看详细指南

3. **不要清理后台**
   - 不要从"最近任务"中划掉应用
   - 不要使用清理大师类应用

4. **保持应用在后台运行**
   - 小米、华为等品牌手机特别需要允许自启动

5. **测试验证**
   - 设置短时间（2-3分钟）后的提醒
   - 观察是否收到
   - 逐步调整设置直到正常工作

### 参考资源

- [Don't Kill My App](https://dontkillmyapp.com) - 各品牌手机后台限制解决方案
- [Android 电池优化文档](https://developer.android.com/training/monitoring-device-state/doze-standby)
- [flutter_local_notifications 插件文档](https://pub.dev/packages/flutter_local_notifications)

### 仍然有问题？

如果按照上述步骤仍然无法解决：

1. 在调试控制台查看完整日志
2. 记录以下信息：
   - 手机品牌和型号
   - Android 版本
   - 通知权限状态（从调试控制台）
   - 待处理通知数量
   - 完整的日志截图
3. 提交问题报告

## 更新日志

- 2026-02-15: 添加诊断日志功能，增强问题排查能力
- 2026-02-15: 添加通知队列验证功能
